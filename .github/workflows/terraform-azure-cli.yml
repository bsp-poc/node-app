on:
  push:
    branches: [ "terraform" ]

name: AzureCLISample
permissions:
  contents: read
  pages: write
  id-token: write
  
jobs:

  build-and-deploy:
    runs-on: ubuntu-latest
    steps:


    - name: checkout latest from running bracnh ${GITHUB_REF##*/}
      uses: actions/checkout@v3

    - name: Setup Terraform with specified version on the runner
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
   
    # - name: execute terraform scripts
    #   run: |
    #     export ARM_CLIENT_ID="${{ secrets.ARM_CLIENT_ID}}"
    #     export ARM_CLIENT_SECRET="${{ secrets.ARM_CLIENT_SECRET}}"
    #     export ARM_SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID}}"
    #     export ARM_TENANT_ID="${{ secrets.ARM_TENANT_ID}}"

    - name: Azure Login
      uses: azure/login@v1
      with:
        #creds: ${{ secrets.AZURE_CREDENTIALS}}
        client-id: ${{ secrets.ARM_CLIENT_ID }}
        tenant-id: ${{ secrets.ARM_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}


    - name: execute terraform
      run: |
        cd terraform
        terraform init
        terraform fmt
        terraform validate
        terraform apply -auto-approve -input=false